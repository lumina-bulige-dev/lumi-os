#!/usr/bin/env bash

set -e

cd "$(dirname "$0")/.."

echo "==> Detecting breaking changes"

# Define test paths for the lumi-os repository
# These are key TypeScript files that define the API surface
TEST_PATHS=(
	lumi-core-api/src/index.ts
	luminabulige_app/app/lib/db.ts
	luminabulige_app/app/lib/cia.ts
	luminabulige_app/app/types/money.ts
	luminabulige_app/app/lib/db/types.ts
	luminabulige_app/app/cia/model.ts
	middleware.ts
)

for PATHSPEC in "${TEST_PATHS[@]}"; do
    # Try to check out previous versions of the source files
    # with the current codebase.
    git checkout "$1" -- "${PATHSPEC}" 2>/dev/null || true
done

# Instead of running tests, use TypeScript compiler to check if an
# older version is no longer compatible with the latest codebase.
# This will detect breaking changes in types and interfaces.
echo "==> Running TypeScript compiler to detect type breaking changes"

# Check if TypeScript compilation succeeds with old files
if command -v npx &> /dev/null; then
    npx tsc --noEmit
else
    echo "Warning: npx not found, skipping TypeScript check"
fi

echo "==> Breaking change detection complete"
