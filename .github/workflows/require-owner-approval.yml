name: require-owner-approval
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, edited]
permissions:
  pull-requests: read
  contents: read
  statuses: write

jobs:
  gate:
    runs-on: ubuntu-latest
    steps:
      - name: Check if REQUIRED_APPROVER approved
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.number }}
          REQUIRED: ${{ vars.REQUIRED_APPROVER }}
        run: |
          if [ -z "$REQUIRED" ]; then
            echo "::notice::Repo variable REQUIRED_APPROVER is not set, skipping approval check"
            exit 0
          fi
          # Get approval reviews
          reviews=$(gh api repos/$OWNER/$REPO/pulls/$PR_NUMBER/reviews \
            --jq '.[] | select(.state=="APPROVED") | .user.login')
          echo "Approvals: $reviews"
          # Check if required approver is in the list
          if ! echo "$reviews" | grep -Fx "$REQUIRED" >/dev/null; then
            echo "::error::Approval required from $REQUIRED"
            exit 1
          fi
      - name: Report success
        run: echo "Owner approval check completed."
