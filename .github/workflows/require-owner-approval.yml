name: require-owner-approval
on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, edited]
permissions:
  pull-requests: read
  contents: read
  statuses: write

jobs:
  gate:
    runs-on: ubuntu-latest
    steps:
      - name: Check if REQUIRED_APPROVER approved
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.number }}
          REQUIRED: ${{ vars.REQUIRED_APPROVER }}
        run: |
          # If REQUIRED_APPROVER is not set, default to repository owner
          if [ -z "$REQUIRED" ]; then
            REQUIRED="$OWNER"
            echo "::notice::REQUIRED_APPROVER not set, defaulting to repository owner: $REQUIRED"
          fi
          # 承認レビュー取得
          reviews=$(gh api repos/$OWNER/$REPO/pulls/$PR_NUMBER/reviews --jq '.[] | select(.state=="APPROVED") | .user.login')
          echo "Approvals: $reviews"
          echo "$reviews" | grep -Fx "$REQUIRED" >/dev/null || { echo "::error::Approval required from $REQUIRED"; exit 1; }
      - name: Report success
        run: echo "Owner approval satisfied."
