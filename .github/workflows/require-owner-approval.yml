  - name: Check if REQUIRED_APPROVER approved
    id: check
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      OWNER: ${{ github.repository_owner }}
      REPO: ${{ github.event.repository.name }}
      PR_NUMBER: ${{ github.event.number }}
      REQUIRED: ${{ vars.REQUIRED_APPROVER }}
    run: |
      if [ -z "$REQUIRED" ]; then
        echo "::notice::Repo variable REQUIRED_APPROVER is not set, skipping approval check"
        exit 0
      fi

      # Get approval reviews via REST API
      reviews_json=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
        -H "Accept: application/vnd.github+json" \
        "https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUMBER/reviews")

      # Extract approved reviewer logins (if jq missing this will fail; ubuntu runners usually have jq)
      approvals=$(echo "$reviews_json" | jq -r '.[] | select(.state=="APPROVED") | .user.login' || true)
      echo "Approvals: $approvals"

      if ! echo "$approvals" | grep -Fx "$REQUIRED" >/dev/null; then
        echo "::error::Approval required from $REQUIRED"
        exit 1
      fi

  - name: Report success
    run: echo "Owner approval check completed."
