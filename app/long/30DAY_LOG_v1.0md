<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>LUMI / 30日ログ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      background: #0f172a;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }
    .page {
      max-width: 640px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .card {
      background: #020617;
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .summary {
      font-size: 16px;
      margin-bottom: 8px;
    }
    .sub {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 12px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      margin-right: 6px;
      font-size: 12px;
      border: 1px solid #475569;
    }
    .safe { color: #4ade80; border-color: #4ade80; }
    .warn { color: #facc15; border-color: #facc15; }
    .danger { color: #f87171; border-color: #f87171; }

    .share-box {
      margin-top: 20px;
      font-size: 14px;
      line-height: 1.6;
    }
    .share-btn {
      display: inline-block;
      padding: 10px 16px;
      margin-top: 10px;
      color: #e5e7eb;
      background: #1e293b;
      border-radius: 999px;
      text-decoration: none;
      border: 1px solid #475569;
    }
  </style>
</head>
<script>
  // ====== 直近30日レンジ ======
  function getLast30Range() {
    const today = new Date();
    const to = today.toISOString().slice(0, 10);
    const fromDate = new Date(today);
    fromDate.setDate(today.getDate() - 29);
    const from = fromDate.toISOString().slice(0, 10);
    return { from, to };
  }

  function addDays(isoDate, add) {
    const d = new Date(isoDate + "T00:00:00Z");
    d.setUTCDate(d.getUTCDate() + add);
    return d.toISOString().slice(0, 10);
  }

  function parseDaysCount(text) {
    const t = (text || "").toString();
    const m = t.match(/(\d+)\s*日/);
    if (m) return Number(m[1]);
    const m2 = t.match(/(\d+)/);
    return m2 ? Number(m2[1]) : 0;
  }

  function inferLevelFromText(t) {
    const s = (t || "").toUpperCase();
    if (s.includes("DANGER")) return "DANGER";
    if (s.includes("WARNING") || s.includes("WARN")) return "WARNING";
    if (s.includes("SAFE")) return "SAFE";

    // あなたのダミー文言に合わせた推定
    if ((t || "").includes("反省") || (t || "").includes("止まれず")) return "DANGER";
    if ((t || "").includes("直前") || (t || "").includes("注意")) return "WARNING";
    if ((t || "").includes("成功") || (t || "").includes("止まれた") || (t || "").includes("GOOD")) return "SAFE";

    return "WARNING";
  }

  function parseDiffYen(t) {
    const m = (t || "").match(/[¥￥]\s*([\d,]+)/);
    return m ? Number(m[1].replace(/,/g, "")) : undefined;
  }

  // ====== このLP HTML専用の抽出（あなたのclassに合わせた） ======
  function extractLumi30DayFromLPDOM() {
    const range = getLast30Range();

    // あなたのHTML: <div class="badge safe"> ... </div>
    const safeBadge = document.querySelector(".badge.safe");
    const warnBadge = document.querySelector(".badge.warn");
    const dangerBadge = document.querySelector(".badge.danger");

    const counts = {
      SAFE: parseDaysCount(safeBadge && safeBadge.innerText),
      WARNING: parseDaysCount(warnBadge && warnBadge.innerText),
      DANGER: parseDaysCount(dangerBadge && dangerBadge.innerText),
    };

    // あなたのHTML: 2枚目カードの <ul><li>Day ...</li></ul>
    const lis = Array.from(document.querySelectorAll(".card ul li"));
    const logs = lis.map((li) => {
      const text = li.innerText || "";

      const dayM = text.match(/Day\s*(\d+)/i);
      const dayIndex = dayM ? Number(dayM[1]) : undefined;

      const date =
        (dayIndex && dayIndex >= 1 && dayIndex <= 30)
          ? addDays(range.from, dayIndex - 1)
          : range.to;

      return {
        date,
        level: inferLevelFromText(text),
        diffYen: parseDiffYen(text),
        note: text,
      };
    });

    return { range, counts, logs };
  }

  // ====== 超軽量モーダル ======
  function openShareModal(onSubmit) {
    const old = document.getElementById("lumi-share-modal");
    if (old) old.remove();

    const modal = document.createElement("div");
    modal.id = "lumi-share-modal";
    modal.style.cssText = `
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:flex-end; justify-content:center; z-index:9999;
    `;
    modal.innerHTML = `
      <div style="
        width:min(640px, 100%); background:#020617; border:1px solid #1e293b;
        border-radius:16px 16px 0 0; padding:16px; color:#e5e7eb;">
        <div style="font-size:14px; opacity:.9; margin-bottom:10px;">誰に見せますか？（ラベル）</div>

        <select id="lumi-share-label" style="
          width:100%; padding:12px; border-radius:12px; background:#0b1220;
          border:1px solid #1e293b; color:#e5e7eb; font-size:14px;">
          <option value="family">家族</option>
          <option value="cofounder">共同経営者</option>
          <option value="accountant">税理士</option>
          <option value="investor">投資家</option>
          <option value="myself">自分</option>
          <option value="other">その他</option>
        </select>

        <div style="display:grid; gap:10px; margin-top:12px;">
          <button id="lumi-share-go" style="
            height:48px; border-radius:999px; border:1px solid rgba(70,182,255,.4);
            background:rgba(255,255,255,.06); color:#e5e7eb; font-weight:650;">
            共有データを作る（MVP）
          </button>
          <button id="lumi-share-cancel" style="
            height:44px; border-radius:999px; border:1px solid #475569;
            background:transparent; color:#94a3b8;">
            キャンセル
          </button>
        </div>

        <div style="margin-top:10px; font-size:12px; color:#94a3b8; line-height:1.5;">
          ※ 銀行ではありません／資金は預かりません／投資助言はしません。<br>
          ※ まずは「共有用データ」MVPです（後でVerified PDFに差し替えます）。
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    modal.addEventListener("click", (e) => {
      if (e.target === modal) modal.remove();
    });
    modal.querySelector("#lumi-share-cancel").addEventListener("click", () => modal.remove());
    modal.querySelector("#lumi-share-go").addEventListener("click", async () => {
      const label = modal.querySelector("#lumi-share-label").value;
      modal.remove();
      await onSubmit(label);
    });
  }

  // ====== createVerifiedPdf の仮実装（いまはJSON共有にしておく） ======
    // ====== createVerifiedPdf（いまは「テキスト共有」最優先で確実に動かす） ======
  window.createVerifiedPdf = async function (payload) {
    const url = window.location.href;

    // 共有したい本文（あとで好きに整形してOK）
    const text =
      `LUMI 30日ログ（MVP）\n` +
      `share_to=${payload.share_to_label}\n` +
      `期間: ${payload.range.from}〜${payload.range.to}\n` +
      `SAFE:${payload.counts.SAFE} / WARNING:${payload.counts.WARNING} / DANGER:${payload.counts.DANGER}\n` +
      `URL: ${url}`;

    // 1) Web Share（最優先）
    try {
      if (navigator.share) {
        await navigator.share({
          title: "LUMI 30日ログ（MVP）",
          text,
          url,
        });
        return;
      }
    } catch (e) {
      // ユーザーがキャンセルした等もここに来るので握りつぶしでOK
    }

    // 2) クリップボード（次点）
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        alert("シェア文をコピーしました。SNS/チャットに貼ってください。");
        return;
      }
    } catch (e) {}

    // 3) 最終フォールバック（手動コピー）
    prompt("コピーして共有してください", text);
  };


  // ====== ボタンに配線 ======
  document.addEventListener("DOMContentLoaded", () => {
    const shareBtn = document.querySelector(".share-btn");
    if (!shareBtn) return;

    shareBtn.addEventListener("click", async (e) => {
      e.preventDefault();

      openShareModal(async (share_to_label) => {
        const { range, counts, logs } = extractLumi30DayFromLPDOM();
        await window.createVerifiedPdf({ share_to_label, range, counts, logs });
      });
    });
  });
</script>
<body>
  <div class="page">

    <h1>30日ログ（β）</h1>

    <div class="card">
      <div class="summary">30日のまとめ</div>
      <div class="sub">この30日で、あなたが “どこで止まれたか・どこで行きすぎたか” が一目で分かる記録です。</div>

      <div class="badge safe">勝ち越し：18日</div>
      <div class="badge warn">引き分け：8日</div>
      <div class="badge danger">反省日：4日</div>
    </div>

    <div class="card">
      <div class="summary">行動ログの一例（ダミー）</div>
      <div class="sub">実際には HOME の daily log から自動生成されます。</div>

      <ul>
        <li>Day 3：SAFE_NULL（よく止まれた日）</li>
        <li>Day 7：¥4,000 セーフムーブ成功</li>
        <li>Day 12：止まれず反省日</li>
        <li>Day 20：DANGER 直前で停止（GOOD）</li>
      </ul>
    </div>

    <div class="card share-box">
      LUMI が作った 30日の行動ログです。  
      言い訳ではなく、今月どう生きたかが “そのまま” 残っています。  
      このページ、あなたなら誰に見せますか？

      <a class="share-btn" href="#">シェアする（準備中）</a>
    </div>

  </div>
</body>
</html>
